<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script type="text/javascript" charset="utf-8" src="jquery.js"></script> 
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Making Free-to-Play In-App Purchases</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="custom.css" rel="stylesheet" type="text/css" />
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEACABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAAAABMLAAATCwAAAAEAAAAAAAD///4AaK1OAFdqRACgoJIAm8ltAGrRmQAzghYANdetAC3PigCWypcAydLJAEySLgApxWQALqtiAHeEagBUwWcAK72OAOTkxABUsooA0OTNAIo8OwAb+MkA5+3iAMPGpgA6ti4ApNTAAPT29QBo6tMA3t7dACjWmwAj3asAGOmrAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGgkNEAcHHQgMDBgGAhwAABYNEAcHHQgMDQ0GBgIDGgAKDRAHHQwNCwsGBgYGDgoACRAHCA8BCwsLCwYGBgIDGgkQEgEBAQEBAQELCwsCDhwJEBIPDwQJCQkJBAEYBg4cCRAHBwgHBQUFBQ8PGAsOCgoQBwICHh8dCAgMCwILDhwWEAcUFBIVHR0IDAIUCwMaGhkIAxQSFR4dDA8DDgsKAAAaBQUZGxUHHQwYBA4XAAAAABMFCAcdCAwYGAEKGgAAAAAAEw8NDQ8PCwMcAAAAAAAAABYEBAQEBAMaAAAAAAAAAAAAEQQEBAMcAAAAAAAAAAAAAAARFxccAAAAAAAAAAAAAp4AAAACAAD//wAAAAQAAACgAAADuQAAASwAAAACAAD//wAAAF0AAP8PAAAAAgAA/fAAAHAwAAAAAAAAABQ=" type="image/x-icon" />
<script type="text/javascript" charset="utf-8" src="jquery.js"></script> 
<script type="text/javascript" charset="utf-8">
$(function() {
	var nav1 = $('#navrow1');
	var nav2 = $('#navrow2');
	var header = [
];
	if(!$('[href="pages.html"]').parent().hasClass('current')) {
		return;
	}
	var lis = $.map(header, function(head) {
		return '<li><a href="'+head[0]+'"><span>'+head[0]+'</span></a></li>';
	}).join('');
	var ul = $('<ul style="width:100%;"></ul>').attr({class: 'tablist'}).html(lis);
	var div = $('<div></div>').attr({id: 'navrow2', class: 'tabs2'}).append(ul);
	div.insertAfter(nav1);
});
</script>
</head>
<body>
<div id="top"><!-- do not remove this div! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Icon-72.png"></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Big Fish iOS SDK
   &#160;<span id="projectnumber">4.9</span>
   </div>
   <div id="projectbrief">Enable your iOS games with Big Fish components</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- Generated by Doxygen 1.8.4 (BFG Build 3) -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Getting&#160;Started</span></a></li>
      <li><a href="_freemium.html"><span>Freemium&#160;Games</span></a></li>
      <li class="current"><a href="_f2_p.html"><span>Free-to-Play&#160;Games</span></a></li>
      <li><a href="reference_overview.html"><span>Technical&#160;References</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="_f_a_q.html"><span>FAQ</span></a></li>
      <li><a href="_whatsnew.html"><span>Release&#160;Notes</span></a></li>
      <li><a href="pages.html"><span>Document&#160;Index</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="_f2_p.html"><span>Free-to-Play&#160;Overview</span></a></li>
      <li><a href="f2p_main_menu.html"><span>Main&#160;Menu&#160;Best&#160;Practices</span></a></li>
      <li><a href="f2p_game_flow.html"><span>Game&#160;Flow&#160;on&#160;Launch</span></a></li>
      <li><a href="f2p_facebook.html"><span>Facebook&#160;Best&#160;Practices</span></a></li>
      <li class="current"><a href="f2p_purchase.html"><span>Free-to-Play&#160;In-App&#160;Purchase</span></a></li>
      <li><a href="f2p_usability.html"><span>Usability&#160;Requirements</span></a></li>
      <li><a href="f2p_production.html"><span>Production&#160;Requirements</span></a></li>
      <li><a href="f2p_checklist.html"><span>Development&#160;Checklist</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Making Free-to-Play In-App Purchases </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#f2p_iap_overview">Making In-App Purchases with the Big Fish iOS SDK</a></li>
<li class="level1"><a href="#f2p_iap_implementationSteps">Implementing Big Fish In-App Purchases into Your Game</a><ul><li class="level2"><a href="#f2p_iap_removeDefaultProductID">Step 1: Add the HBI value and remove the default productID</a></li>
<li class="level2"><a href="#f2p_iap_notifications_bfgPurchase">Step 2: Listen for bfgPurchase notifications</a></li>
<li class="level2"><a href="#f2p_iap_initiate_bfgPurchase">Step 3: Initiate bfgPurchase</a></li>
<li class="level2"><a href="#f2p_iap_acquireProdInfo">Step 4: Acquire product information</a></li>
<li class="level2"><a href="#f2p_iap_canStartPurchase">purchase Step 5: canStartPurchase (optional)</a></li>
<li class="level2"><a href="#f2p_iap_initiate_purchase">Step 6: Initiate the purchase</a><ul><li class="level3"><a href="#f2p_IAPviaPlacements">In-App Purchasing via placements</a></li>
</ul>
</li>
<li class="level2"><a href="#cancel_bfgPurchaseObject">bfgPurchaseObject canceled field</a></li>
<li class="level2"><a href="#f2p_iap_finish_purchase">Step 7: Finish the purchase</a></li>
</ul>
</li>
<li class="level1"><a href="#f2pTransactions">Free-to-Play Purchase Transaction Events</a></li>
<li class="level1"><a href="#f2p_iap_restore_a_purchase">Restoring Purchases</a><ul><li class="level2"><a href="#f2p_iap_restoreEvents">Restore transaction events</a></li>
<li class="level2"><a href="#f2p_iap_successCheckRestore">Purchase restore success check</a></li>
<li class="level2"><a href="#f2p_iap_restoreCodeExample">Example code</a></li>
</ul>
</li>
<li class="level1"><a href="#iap_reporting">In-App Purchasing Reporting</a></li>
<li class="level1"><a href="#f2p_purchaseVerificationModes">Purchase Verification Modes for Free-to-Play Games</a></li>
<li class="level1"><a href="#f2p_purchaseOtherBestPractices">Other Best Practices</a><ul><li class="level2"><a href="#purchase_cannot_be_canceled">Purchases cannot be canceled by the app</a></li>
<li class="level2"><a href="#f2p_be_ready_for_purchase_notification">Always be ready for a purchase notification</a></li>
<li class="level2"><a href="#f2p_notifications_occur_main_thread">bfgPurchase notifications occur on the main thread</a></li>
<li class="level2"><a href="#f2p_sequence">Keep in mind the bfgPurchase sequence</a></li>
<li class="level2"><a href="#f2p_restore_purchases">Provide a means to restore purchases</a></li>
<li class="level2"><a href="#f2p_purchases_taking_too_long">What to do when purchases are taking too long</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>Implementing In-App Purchases with <a class="el" href="interfacebfg_purchase.html" title="Manages Apple&#39;s In-App Purchases. ">bfgPurchase</a>.</p>
<h1><a class="anchor" id="f2p_iap_overview"></a>
Making In-App Purchases with the Big Fish iOS SDK</h1>
<p>Games integrating with the Big Fish iOS SDK are required to use its implementation of In-App Purchases. This implementation, called <a class="el" href="interfacebfg_purchase.html" title="Manages Apple&#39;s In-App Purchases. ">bfgPurchase</a>, handles the purchase, purchase verification, and logging.</p>
<ul>
<li>For more information about In-App Purchases in general, see Apple's <a href="http://developer.apple.com/library/mac/#documentation/NetworkingInternet/Conceptual/StoreKitGuide/Introduction/Introduction.html" class="el" target="_blank">In-App Purchase Programming Guide</a>.</li>
<li>For more information about the Big Fish iOS SDK purchase methods, see <a class="el" href="reference_class.html#iapSupport">In-App Purchase Support - bfgPurchase</a>.</li>
</ul>
<h1><a class="anchor" id="f2p_iap_implementationSteps"></a>
Implementing Big Fish In-App Purchases into Your Game</h1>
<h2><a class="anchor" id="f2p_iap_removeDefaultProductID"></a>
Step 1: Add the HBI value and remove the default productID</h2>
<p>First, add the HBI value to the <b>bfg_default_settings.json</b> file. The HBI value will be given to you by your Big Fish Producer. You will <em>not</em> be able to successfully purchase products without this key.</p>
<p>As Free-to-Play games generally have many productIDs, you should remove the productID in the default settings in the <b>bfg_default_settings.json</b> file for <b>iap_default_product_id</b>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    <span class="stringliteral">&quot;allowed_ad_types&quot;</span>:</div>
<div class="line">    [</div>
<div class="line">      <span class="stringliteral">&quot;bfg&quot;</span></div>
<div class="line">    ],</div>
<div class="line">    <span class="stringliteral">&quot;hbi&quot;</span> : <span class="stringliteral">&quot;e7338febd01d7911fdb2156ba4bfbe1d922d4a9&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;dashboard_display_type&quot;</span>:<span class="stringliteral">&quot;free&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;dashboard_active&quot;</span>:1,</div>
<div class="line">    <span class="stringliteral">&quot;dashboard_show_after_this_many_runs&quot;</span>:1,</div>
<div class="line">    <span class="stringliteral">&quot;iap_default_product_id&quot;</span>:<span class="stringliteral">&quot;com.bigfishgames.bfgsdkios.seunlock&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;flurryapikey&quot;</span>:<span class="stringliteral">&quot;XXLHVS3BWUU2VVTILTZD&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;rating_days_until_prompt&quot;</span>:0,</div>
<div class="line">    <span class="stringliteral">&quot;rating_uses_until_prompt&quot;</span>:0,</div>
<div class="line">    <span class="stringliteral">&quot;rating_significant_events_until_prompt&quot;</span>:3,</div>
<div class="line">    <span class="stringliteral">&quot;rating_days_before_reminding&quot;</span>:1</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="f2p_iap_notifications_bfgPurchase"></a>
Step 2: Listen for bfgPurchase notifications</h2>
<p>After the game has loaded - the SDK is initialized by calling <a class="el" href="interfacebfg_manager.html" title="Initialize the Big Fish Game Components. ">bfgManager</a> - start listening for these notifications:</p>
<ul>
<li><a class="el" href="bfg_purchase_8h.html#a166f99b6c7dc52435dc2da60e545cac5">NOTIFICATION_PURCHASE_FAILED</a></li>
<li><a class="el" href="bfg_purchase_8h.html#a122296918454fac68c7258ce6c40d7a2">NOTIFICATION_PURCHASE_SUCCEEDED</a></li>
<li><a class="el" href="bfg_purchase_8h.html#adaf19c7846031eb9021365a4bfdf454c">NOTIFICATION_RESTORE_FAILED</a></li>
<li><a class="el" href="bfg_purchase_8h.html#af4c4d831ed5cc9dfe39e99450af204c5">NOTIFICATION_RESTORE_SUCCEEDED</a></li>
<li><a class="el" href="bfg_purchase_8h.html#ad88b135211ddda91b8dba29e2037be15">NOTIFICATION_PURCHASE_PRODUCTINFORMATION</a></li>
<li><b>BFG_NOTIFICATION_PLACEMENT_CONTENT_START_PURCHASE</b> </li>
</ul>
<div class="fragment"><div class="line">...</div>
<div class="line">   [[NSNotificationCenter defaultCenter] addObserver:<span class="keyword">self</span></div>
<div class="line">            selector:<span class="keyword">@selector</span>(acquireProductInfoDidSucceed:)</div>
<div class="line">            name:<a class="code" href="bfg_purchase_8h.html#ad88b135211ddda91b8dba29e2037be15" title="The product information about a purchase. ">NOTIFICATION_PURCHASE_PRODUCTINFORMATION</a> <span class="keywordtype">object</span>:nil];</div>
<div class="line">   [[NSNotificationCenter defaultCenter] addObserver:<span class="keyword">self</span></div>
<div class="line">            selector:<span class="keyword">@selector</span>(purchaseDidFail:) name:<a class="code" href="bfg_purchase_8h.html#a166f99b6c7dc52435dc2da60e545cac5" title="The purchase failed. ">NOTIFICATION_PURCHASE_FAILED</a> <span class="keywordtype">object</span>:nil];</div>
<div class="line">   [[NSNotificationCenter defaultCenter] addObserver:<span class="keyword">self</span></div>
<div class="line">            selector:<span class="keyword">@selector</span>(purchaseDidSucceed:)</div>
<div class="line">            name:<a class="code" href="bfg_purchase_8h.html#a122296918454fac68c7258ce6c40d7a2" title="The purchase succeeded. ">NOTIFICATION_PURCHASE_SUCCEEDED</a> <span class="keywordtype">object</span>:nil];</div>
<div class="line">   [[NSNotificationCenter defaultCenter] addObserver:<span class="keyword">self</span></div>
<div class="line">            selector:<span class="keyword">@selector</span>(restoreDidFail:) name:<a class="code" href="bfg_purchase_8h.html#adaf19c7846031eb9021365a4bfdf454c" title="The restore failed. ">NOTIFICATION_RESTORE_FAILED</a> <span class="keywordtype">object</span>:nil];</div>
<div class="line">   [[NSNotificationCenter defaultCenter] addObserver:<span class="keyword">self</span></div>
<div class="line">            selector:<span class="keyword">@selector</span>(restoreDidSucceed:)</div>
<div class="line">            name:<a class="code" href="bfg_purchase_8h.html#af4c4d831ed5cc9dfe39e99450af204c5" title="The restore succeeded. ">NOTIFICATION_RESTORE_SUCCEEDED</a> <span class="keywordtype">object</span>:nil];</div>
<div class="line">   [[NSNotificationCenter defaultCenter] addObserver:<span class="keyword">self</span></div>
<div class="line">            selector:<span class="keyword">@selector</span>(contentStartPurchase:)</div>
<div class="line">            name:BFG_NOTIFICATION_PLACEMENT_CONTENT_START_PURCHASE  <span class="keywordtype">object</span>:nil]; ...</div>
</div><!-- fragment --><p> <br/>
</p>
<h2><a class="anchor" id="f2p_iap_initiate_bfgPurchase"></a>
Step 3: Initiate bfgPurchase</h2>
<p>When you start purchase services, you may immediately begin receiving notifications if any outstanding purchases did not complete.</p>
<div class="fragment"><div class="line">...</div>
<div class="line">    [<a class="code" href="interfacebfg_purchase.html" title="Manages Apple&#39;s In-App Purchases. ">bfgPurchase</a> startService]</div>
<div class="line">...</div>
</div><!-- fragment --><h2><a class="anchor" id="f2p_iap_acquireProdInfo"></a>
Step 4: Acquire product information</h2>
<p>The notification dictionary returns two key / value pairs. The values are arrays of product ids.</p>
<p>4.1 Acquire product information as defined in <b>bfg_default_settings.json</b>.</p>
<div class="fragment"><div class="line">...</div>
<div class="line">    NSSet *allProductIds = [NSSet setWithArray:@[ kProductIdConsumable, kProductIdUnlock ]];</div>
<div class="line">    [<a class="code" href="interfacebfg_purchase.html" title="Manages Apple&#39;s In-App Purchases. ">bfgPurchase</a> acquireProductInformationForProducts:allProductIds];</div>
<div class="line">...</div>
</div><!-- fragment --><p>4.2. Verify the acquired product information. Listen for the NOTIFICATION_PURCHASE_PRODUCTINFORMATION event. It contains a dictionary of two keys, *_SUCCESSES_* and *_FAILURES_*. The values associated with these keys are arrays of strings. The strings are product IDs.</p>
<ul>
<li>BFG_ACQUIRE_PRODUCT_INFO_SUCCESSES_USER_INFO_KEY returns all product IDs for which product information was acquired.</li>
<li>BFG_ACQUIRE_PRODUCT_INFO_FAILURES_USER_INFO_KEY returns all product IDs for which product information could not be acquired. This generally means the product ID was not found in the App Store.</li>
</ul>
<p>An Acquire Default Product Information Succeed transaction would appear similar to the following code example. This means that the call succeeded, but it does not mean that any product information has been returned yet.</p>
<div class="fragment"><div class="line">      ...</div>
<div class="line">    [[NSNotificationCenter defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(acquireProductInfoDidSucceed:) name:<a class="code" href="bfg_purchase_8h.html#ad88b135211ddda91b8dba29e2037be15" title="The product information about a purchase. ">NOTIFICATION_PURCHASE_PRODUCTINFORMATION</a> <span class="keywordtype">object</span>:nil];</div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line">- (void)acquireProductInfoDidSucceed:(NSNotification *)notification</div>
<div class="line">{</div>
<div class="line">    NSArray *successes = notification.userInfo[<a class="code" href="bfg_purchase_8h.html#a7167f7fea313856e632d894d6bc14adf" title="Key for notification userInfo that returns an array of productIds of products for which product infor...">BFG_ACQUIRE_PRODUCT_INFO_SUCCESSES_USER_INFO_KEY</a>];</div>
<div class="line">    <span class="keywordflow">if</span> ([successes count])</div>
<div class="line">{</div>
<div class="line"><span class="comment">// Possibly add debug logging showing that the request succeeded</span></div>
<div class="line"><span class="comment">// Set a global flag that purchasing is ready.</span></div>
<div class="line"><span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span> </div>
<div class="line">{</div>
<div class="line"><span class="comment">// Possibly add debug logging showing that the request failed.</span></div>
<div class="line"><span class="comment">// You&#39;ll need to retry acquire later.</span></div>
<div class="line">}</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd><ul>
<li>If [<a href="interfacebfg_purchase.html#a3b0d31b468ec51f0a43ed8af9c24d0a7" class="el">bfgPurchase acquireProductInformation</a>] returns NO, you will need to try again. No purchases can occur until this method succeeds, and you have been notified with the product information..</li>
<li>Products are managed in iTunes Connect, so be sure to handle success and failure cases.</li>
<li>If you are developing on a pre-4.3 version of the Big Fish iOS SDK, be sure that your app downloads the latest product information from the App Store by calling [<a href="interfacebfg_purchase.html#a3b0d31b468ec51f0a43ed8af9c24d0a7" class="el">bfgPurchase acquireProductInformation</a>].</li>
<li>The notification *_USER_INFO_KEY will contain a dictionary with a single <a class="el" href="interfacebfg_purchase_object.html" title="Data for a particular In-App Purchase. ">bfgPurchaseObject</a>. For more information, see the method description at <a class="el" href="interfacebfg_purchase_object.html" title="Data for a particular In-App Purchase. ">bfgPurchaseObject</a>.</li>
<li>SKPaymentTransaction with your <a class="el" href="interfacebfg_purchase_object.html" title="Data for a particular In-App Purchase. ">bfgPurchaseObject</a>. This is the object you receive when you are notified that a purchase succeeded (or failed).</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="f2p_iap_canStartPurchase"></a>
purchase Step 5: canStartPurchase (optional)</h2>
<p>Optionally, you can call [<a href="interfacebfg_purchase.html#ac689943ed96e0df8964d1d87ec3c8dbf" class="el">bfgPurchase canStartPurchase</a>] if you wish to interact with the user before sending the purchase to Apple.</p>
<div class="fragment"><div class="line">... </div>
<div class="line"><span class="comment">// User taps on product icon to initiate purchase</span></div>
<div class="line"><span class="keywordflow">if</span> ([<a class="code" href="interfacebfg_purchase.html" title="Manages Apple&#39;s In-App Purchases. ">bfgPurchase</a> canStartPurchase])</div>
<div class="line">{</div>
<div class="line"><span class="comment">// Possibly present some UI which calls [bfgPurchase startPurchase] when dismissed.</span></div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">{</div>
<div class="line"><span class="comment">// Present UI indicating that the purchase cannot be completed at this time.</span></div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="f2p_iap_initiate_purchase"></a>
Step 6: Initiate the purchase</h2>
<p>6.1 When the user initiates a purchase, call [<a href="interfacebfg_purchase.html#accc2f70e8646edd2fbe043388ea10ff6" class="el">bfgPurchase startPurchase:productId</a>].</p>
<div class="fragment"><div class="line">- (void)purchaseByProductID:(NSString *)productId</div>
<div class="line">{</div>
<div class="line">    [<a class="code" href="interfacebfg_purchase.html" title="Manages Apple&#39;s In-App Purchases. ">bfgPurchase</a> startPurchase:productId];</div>
<div class="line">}</div>
</div><!-- fragment --><p>6.2 Wait for:</p>
<ul>
<li><a class="el" href="bfg_purchase_8h.html#a122296918454fac68c7258ce6c40d7a2">NOTIFICATION_PURCHASE_SUCCEEDED</a> and <a class="el" href="bfg_purchase_8h.html#a166f99b6c7dc52435dc2da60e545cac5">NOTIFICATION_PURCHASE_FAILED</a>. The notification userInfo will contain a dictionary with a single <a class="el" href="interfacebfg_purchase_object.html" title="Data for a particular In-App Purchase. ">bfgPurchaseObject</a>.</li>
<li><a class="el" href="bfg_purchase_8h.html#a754bb6a9980b0e6e78685c6fd2e17cab">BFG_PURCHASE_OBJECT_USER_INFO_KEY</a> will key to this object. It contains all of the information about the purchase.<br/>
</li>
</ul>
<p>6.3 On success, the game performs the unlock and persists the state of the game and purchase. The game needs to store the information that the purchase has succeeded. The Big Fish SDK will not store the purchase.</p>
<h3><a class="anchor" id="f2p_IAPviaPlacements"></a>
In-App Purchasing via placements</h3>
<p>Placement views can be configured to initiate In-App Purchases in your games. You will receive the following notifications when these events happen:</p>
<ul>
<li>BFG_NOTIFICATION_PLACEMENT_CONTENT_START_PURCHASE - A purchase has been requested. You game should start the purchase.</li>
</ul>
<p>This notification contains the following keys in the <code>userInfo</code> dictionary:</p>
<ul>
<li>BFG_PLACEMENT_PURCHASE_PRODUCTID_KEY = "purchaseProductID"</li>
<li>BFG_PLACEMENT_PURCHASE_ITEM_KEY = "purchaseItem"</li>
<li>BFG_PLACEMENT_PURCHASE_QUANTITY_KEY = "purchaseQuantity"</li>
<li>BFG_PLACEMENT_PURCHASE_RECEIPT_KEY = "purchaseReceipt"</li>
</ul>
<p>After receiving the event Developers will need to call startPurchase with the <b>purchaseProductID</b>.</p>
<div class="fragment"><div class="line">...</div>
<div class="line">- (void)contentStartPurchase:(NSNotification *)notification {</div>
<div class="line">   NSString * purchaseProductID =</div>
<div class="line">notification.userInfo[BFG_PLACEMENT_PURCHASE_PRODUCTID_KEY];</div>
<div class="line">  [<a class="code" href="interfacebfg_purchase.html" title="Manages Apple&#39;s In-App Purchases. ">bfgPurchase</a> startPurchase:purchaseProductID] } ...</div>
</div><!-- fragment --><h2><a class="anchor" id="cancel_bfgPurchaseObject"></a>
bfgPurchaseObject canceled field</h2>
<p>The <a class="el" href="interfacebfg_purchase_object.html" title="Data for a particular In-App Purchase. ">bfgPurchaseObject</a> has a field called <b>canceled</b>. When a purchase is started, Apple presents the user with the opportunity to accept or cancel the purchase. If the user cancels the purchase, the purchase fails. When your code is notified that the purchase failed, check the <b>canceled</b> field of the <a class="el" href="interfacebfg_purchase_object.html" title="Data for a particular In-App Purchase. ">bfgPurchaseObject</a>.</p>
<ul>
<li>If the value is NO, let the user know that the purchase did not succeed.</li>
<li>If the value is YES, you do not do not need to do anything, as the user was expecting the purchase to fail.</li>
</ul>
<h2><a class="anchor" id="f2p_iap_finish_purchase"></a>
Step 7: Finish the purchase</h2>
<p>Call [<a href="interfacebfg_purchase.html#acc2e99bf4adedd1bfb58f989198d70f6" class="el">bfgPurchase finishPurchase:(NSString *)productId</a>] for every product for which you receive a notification_purchase_succeeded notification.</p>
<p>This is a required step to finish the purchase transaction. If you do not make this call, your game will keep receiving notifications for completed purchases each time it starts and the user will not be able to purchase the product again.</p>
<dl class="section note"><dt>Note</dt><dd>Once the purchase finishes, you will receive a notification called NOTIFICATION_FINISH_PURCHASE_COMPLETE. It contains a product id in the userInfo called BFG_PRODUCT_ID_USER_INFO_KEY.</dd></dl>
<h1><a class="anchor" id="f2pTransactions"></a>
Free-to-Play Purchase Transaction Events</h1>
<p>A typical scenario for a Free-to-Play purchase transaction will include these events:</p>
<div class="image">
<img src="iOS_4_6_Free-to-Play_Purchase.png" alt="iOS_4_6_Free-to-Play_Purchase.png"/>
</div>
<ol type="1">
<li>Game initializes the Big Fish SDK by calling <a class="el" href="interfacebfg_manager.html" title="Initialize the Big Fish Game Components. ">bfgManager</a>.</li>
<li>Once the SDK is initialized, the game starts listening for notifications from the SDK.</li>
<li>Game calls [<a href="interfacebfg_purchase.html#a7e65cc9f7675225f2133d39a56fa1fe1" class="el">bfgPurchase startService</a>].</li>
<li>Game calls [<a href="interfacebfg_purchase.html#a3b0d31b468ec51f0a43ed8af9c24d0a7" class="el">bfgPurchase acquireProductInformation</a>].</li>
<li>On success, game optionally calls [<a href="interfacebfg_purchase.html#ac689943ed96e0df8964d1d87ec3c8dbf" class="el">bfgPurchase canStartPurchase</a>].</li>
<li>On a virtual good purchase event, game calls [<a href="interfacebfg_purchase.html#a4d7cbaedc86eedfc982514ce59d77228" class="el">bfgPurchase startPurchase</a>].</li>
<li>On success, a <a class="el" href="interfacebfg_purchase_object.html" title="Data for a particular In-App Purchase. ">bfgPurchaseObject</a> will be created. BFG_PURCHASE_OBJECT_USER_INFO_KEY keys to this object and will contain all information about the purchase. The game stores information from the purchase.</li>
<li>Game calls [<a href="interfacebfg_purchase.html#a98ba4e2f7e1a6c2620b4aadb1c0cce74" class="el">bfgPurchase finishPurchase</a>]. A thank you message displays to the user, the purchase unlocks, and game play resumes.</li>
</ol>
<h1><a class="anchor" id="f2p_iap_restore_a_purchase"></a>
Restoring Purchases</h1>
<p>A typical scenario for a Free-to-Play restore transaction will include these events:</p>
<div class="image">
<img src="iOS_4_6_Free-to-Play_Restore.png" alt="iOS_4_6_Free-to-Play_Restore.png"/>
</div>
<h2><a class="anchor" id="f2p_iap_restoreEvents"></a>
Restore transaction events</h2>
<p>When the user wishes to restore a purchase:</p>
<ol type="1">
<li>Call [<a href="interfacebfg_purchase.html#a2c14a1e6ebedf6086858bdf302ff0203" class="el">bfgPurchase restorePurchases</a>].</li>
<li>Wait for:<ul>
<li>Any number of <a class="el" href="bfg_purchase_8h.html#a122296918454fac68c7258ce6c40d7a2">NOTIFICATION_PURCHASE_SUCCEEDED</a> and <a class="el" href="bfg_purchase_8h.html#a166f99b6c7dc52435dc2da60e545cac5">NOTIFICATION_PURCHASE_FAILED</a> notifications. Each will contain a dictionary with a single <a class="el" href="interfacebfg_purchase_object.html" title="Data for a particular In-App Purchase. ">bfgPurchaseObject</a>. <a class="el" href="bfg_purchase_8h.html#a754bb6a9980b0e6e78685c6fd2e17cab">BFG_PURCHASE_OBJECT_USER_INFO_KEY</a> will key to this object. It contains all of the information about the purchase.</li>
<li>You should receive a NOTIFICATION_PURCHASE_SUCCEEDED notification for every previously purchased non-consumable. You could receive as few as 0 and as many as you have non-consumables for sale. You can never have two of the same non-consumable, so all results will be unique. After all of these notifications have posted, NOTIFICATION_RESTORE_SUCCEEDED or NOTIFICATION_RESTORE_FAILED will be posted.</li>
</ul>
</li>
<li>On success, perform the unlock and persist the state.</li>
<li>Wait for <a class="el" href="bfg_purchase_8h.html#af4c4d831ed5cc9dfe39e99450af204c5">NOTIFICATION_RESTORE_SUCCEEDED</a> or <a class="el" href="bfg_purchase_8h.html#adaf19c7846031eb9021365a4bfdf454c">NOTIFICATION_RESTORE_FAILED</a>. This is your indication that all products that can be restored at this time have been restored.</li>
</ol>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>If you receive a failure, Apple could not be reached and you should indicate to the user that the restore could not be completed.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="f2p_iap_successCheckRestore"></a>
Purchase restore success check</h2>
<p>NOTIFICATION_RESTORE_SUCCEEDED is posted even if zero items have been restored. This is intentional – the failure notification tells the SDK something went wrong during the restore. The success notification tells how many products were restored.</p>
<p>The following is a simplified procedure based on a sample app:</p>
<ol type="1">
<li>When user presses "restore", set a variable "restoreCount" to 0.</li>
<li>If you get a NOTIFICATION_PURCHASE_SUCCEEDED notification, increment this count.</li>
<li>If you get a NOTIFICATION_RESTORE_SUCCEEDED notification, check this count. If it is 0, no items were restored. Otherwise you will get a NOTIFICATION_RESTORE_FAILED notification. In this case, tell the user that restore failed.</li>
</ol>
<h2><a class="anchor" id="f2p_iap_restoreCodeExample"></a>
Example code</h2>
<div class="fragment"><div class="line"><span class="keyword">@interface </span>Restore : NSObject</div>
<div class="line"><span class="keyword">@property</span> (nonatomic, assign) NSInteger restoreCount;</div>
<div class="line">- (void)restorePurchases;</div>
<div class="line">- (void)handlePurchaseSucceeded:(NSNotification *notification);</div>
<div class="line">- (void)handleRestoreSucceeded:(NSNotification *notification);</div>
<div class="line">- (void)handleRestoreFailed:(NSNotification *notification);</div>
<div class="line"><span class="keyword">@end</span></div>
<div class="line"><span class="keyword">@implementation </span>Restore</div>
<div class="line">- (id)init</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">self</span>)</div>
<div class="line">    {</div>
<div class="line">        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(handlePurchaseSucceeded:) name:NOTIFICATION_PURCHASE_SUCCEEDED object:nil];</div>
<div class="line">        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(handleRestoreFailed:) name:NOTIFICATION_RESTORE_FAILED object:nil];</div>
<div class="line">        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(handleRestoreSucceeded:) name:NOTIFICATION_RESTORE_SUCCEEDED object:nil];</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">self</span>;</div>
<div class="line">}</div>
<div class="line">- (void)dealloc</div>
<div class="line">{</div>
<div class="line">    [[NSNotificationCenter defaultCenter] removeObserver:self];</div>
<div class="line">}</div>
<div class="line">- (void)restorePurchases</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">self</span>.restoreCount = 0;</div>
<div class="line">    [<a class="code" href="interfacebfg_purchase.html" title="Manages Apple&#39;s In-App Purchases. ">bfgPurchase</a> <a class="code" href="interfacebfg_purchase.html#a2c14a1e6ebedf6086858bdf302ff0203">restorePurchases</a>];</div>
<div class="line">}</div>
<div class="line">- (void)handlePurchaseSucceeded:(NSNotification *)notification</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">self</span>.restoreCount = <span class="keyword">self</span>.restoreCount + 1;</div>
<div class="line">    unlockGame();</div>
<div class="line">    thankUserForRestoring();</div>
<div class="line">}</div>
<div class="line">- (void)handleRestoreSucceeded:(NSNotification *)notification</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">self</span>.restoreCount == 0)</div>
<div class="line">    {</div>
<div class="line">        showWeDidNotFindYourPurchaseAlert();</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line">- (void)handleRestoreFailed:(NSNotification *)notification</div>
<div class="line">{</div>
<div class="line">    showRestoreFailedAlert();</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="iap_reporting"></a>
In-App Purchasing Reporting</h1>
<p><a class="el" href="interfacebfg_purchase.html" title="Manages Apple&#39;s In-App Purchases. ">bfgPurchase</a> handles all revenue event reporting.</p>
<ul>
<li>The UIKit example implements In-App Purchase using this class. Reference this example and contact your Big Fish Producer if you have any questions.</li>
<li>Create a "dummy app" to test In-App Purchases. For instructions, see <a class="el" href="iap_dummy_app_test.html">Testing In-App Purchases</a>. <br/>
 <br/>
</li>
</ul>
<h1><a class="anchor" id="f2p_purchaseVerificationModes"></a>
Purchase Verification Modes for Free-to-Play Games</h1>
<p>With SDK 4.7, game developers can take advantage of a new security measure with IOS 7 receipts. Your Big Fish Producer will set up one of the following Purchase Verification modes in your game via the Mobile Admin tool.</p>
<ul>
<li>clientOnly Verification Mode: The verification for purchase is done only on the client side. There will still be a call to the purchase service, but this is just for Business Intelligence reporting. (Intended for IOS 7 and later devices.)</li>
<li>serverOnly Verification Mode: There is no clientSide verification, the receipt is sent to the server for verification, and the server does the verification by calling the Apple service. (Intended for IOS 6 and earlier devices.)</li>
<li>clientAndServer Verification Mode: Both client and server verification is done. (Intended for IOS 7 and later devices.)</li>
</ul>
<p>A single game can have two verification modes:</p>
<ol type="1">
<li>IOS 6 Verification Mode: Verification mode targeted for IOS 6 and earlier devices.</li>
<li>IOS 7 Verification Mode: Verification mode targeted for IOS 7 and later devices.</li>
</ol>
<dl class="section note"><dt>Note</dt><dd>iOS 6 can also use clientOnly verification, though it it is not highly secure. Work with your Big Fish Producer to determine the appropriate setting.</dd></dl>
<h1><a class="anchor" id="f2p_purchaseOtherBestPractices"></a>
Other Best Practices</h1>
<h2><a class="anchor" id="purchase_cannot_be_canceled"></a>
Purchases cannot be canceled by the app</h2>
<ul>
<li>Once the user has begun the purchase process with Apple, only the user can cancel it.</li>
<li>Once the user has made a purchase from Apple, the purchase receipt is verified.</li>
<li>If the verification server cannot be reached, the purchase will keep trying to verify in the background. The user has already paid for the item so this process must be allowed to continue.</li>
<li>The purchase will not be allowed to begin if the verification server is unreachable at the start of the purchase.</li>
</ul>
<h2><a class="anchor" id="f2p_be_ready_for_purchase_notification"></a>
Always be ready for a purchase notification</h2>
<ul>
<li>Once the purchase service has been started, a purchase notification can be delivered at any time.</li>
<li>If a purchase is still being processed when the application is exited, it will resume on restart once <a class="el" href="interfacebfg_purchase.html" title="Manages Apple&#39;s In-App Purchases. ">bfgPurchase</a> has been started.</li>
<li>Because a network connection is required to verify the purchase, the purchase cannot complete until the user is connected, which could be some time after start up.</li>
</ul>
<h2><a class="anchor" id="f2p_notifications_occur_main_thread"></a>
bfgPurchase notifications occur on the main thread</h2>
<p>You can count the purchase notifications that occur on the main thread. This could be useful if your app uses UIKit classes.</p>
<h2><a class="anchor" id="f2p_sequence"></a>
Keep in mind the bfgPurchase sequence</h2>
<ol type="1">
<li>Listen for notifications.</li>
<li>Start the purchase service, call [<a href="interfacebfg_purchase.html#a7e65cc9f7675225f2133d39a56fa1fe1" class="el">bfgPurchase startService</a>].</li>
<li>Keep trying to acquire information on your products until you succeed.</li>
<li>When user attempts to purchase, call [<a href="interfacebfg_purchase.html#a4d7cbaedc86eedfc982514ce59d77228" class="el">bfgPurchase startPurchase</a>].</li>
<li>If the purchase succeeds, save the purchase to the game, and then call [<a href="interfacebfg_purchase.html#a98ba4e2f7e1a6c2620b4aadb1c0cce74" class="el">bfgPurchase finishPurchase</a>].</li>
</ol>
<h2><a class="anchor" id="f2p_restore_purchases"></a>
Provide a means to restore purchases</h2>
<p>The [<a href="interfacebfg_purchase.html#a2c14a1e6ebedf6086858bdf302ff0203" class="el">bfgPurchase restorePurchases</a>] method is meant to be interactive, giving users an opportunity to recover non-consumable purchases.</p>
<h2><a class="anchor" id="f2p_purchases_taking_too_long"></a>
What to do when purchases are taking too long</h2>
<p>It is possible that a network issue during purchase may extend the time the user spends waiting to unacceptable limits.</p>
<p>If the game starts a purchase, it can implement a timeout, however, the purchase will still be processing in the background.</p>
<ul>
<li>Let the user know that the purchase is still in progress.</li>
<li>Be prepared for the purchase to complete at any time. </li>
</ul>
</div></div><!-- contents -->

<hr class="footer"/><address class="footer"><small>
</body>
</html>
